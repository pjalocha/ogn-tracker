<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OGN-Tracker Install and Configure</title>
</head>
<body>
  <h1>OGN-Tracker Install Firmware</h1>

  <label for="variant">Variant:</label>
  <select id="variant">
    <option value="ttgo-sx1276-tbeam-v10">T-Beam v1.0 (SX1276)</option>
    <option value="ttgo-sx1262-tbeam-v10">T-Beam v1.0 (SX1262)</option>
    <option value="ttgo-sx1276-tbeam-v12">T-Beam v1.2 (SX1276)</option>
    <option value="ttgo-sx1262-tbeam-v12">T-Beam v1.2 (SX1262)</option>
    <option value="HTIT-Tracker">HTIT-Tracker</option>
    <option value="HTIT-Tracker-low-power">HTIT-Tracker no BT,longer life</option>
    <option value="ThinkNode-M5">ThinkNode-M5</option>
    <option value="ThinkNode-M5-low-power">ThinkNode-M5 no BT,longer life</option>
  </select>

  <div style="margin:16px 0">
    <script type="module" src="https://unpkg.com/esp-web-tools@latest/dist/web/install-button.js?module"></script>
    <esp-web-install-button id="install" manifest="manifests/manifest-ttgo-sx1276-tbeam-v10.json"></esp-web-install-button>
  </div>

  <p>Use Chrome/Edge (Web Serial). Connect USB, then Install.</p>

  <p>If upload fails, you may need to enter bootloader mode by holding USER/BOOT button and pressing RESET or doing power-up.
     After the upload is complete, you need to press RESET again to exit bootloader mode and run the uploaded code</p>

  <h1>OGN-Tracker Configure</h1>

<!-- Command panel -->
<section style="margin-top:16px; padding:12px; border:1px solid #ccc; border-radius:8px;">
  <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <button id="btnConnect">Connect</button>
    <button id="btnDisconnect" disabled>Disconnect</button>

    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <select id="cmdFreqPlan" disabled>
        <option value="">Frequency plan</option>
        <option value="$POGNS,FreqPlan=0">Auto</option>
        <option value="$POGNS,FreqPlan=1">Europe/Africa</option>
        <option value="$POGNS,FreqPlan=2">US/Canada</option>
        <option value="$POGNS,FreqPlan=3">South America/Australia</option>
        <option value="$POGNS,FreqPlan=4">New Zealand</option>
        <option value="$POGNS,FreqPlan=5">Israel</option>
      </select>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <select id="cmdAcftType" disabled>
        <option value="">Aircraft type</option>
        <option value="$POGNS,AcftType=0">Other</option>
        <option value="$POGNS,AcftType=1">(Moto)glider</option>
        <option value="$POGNS,AcftType=2">Tow plane</option>
        <option value="$POGNS,AcftType=3">Helicopter</option>
        <option value="$POGNS,AcftType=4">Parachute</option>
        <option value="$POGNS,AcftType=5">Drop plane</option>
        <option value="$POGNS,AcftType=6">Hang-glider</option>
        <option value="$POGNS,AcftType=7">Para-glider</option>
        <option value="$POGNS,AcftType=8">Powered plane</option>
        <option value="$POGNS,AcftType=9">Jet plane</option>
        <option value="$POGNS,AcftType=10">UFO</option>
        <option value="$POGNS,AcftType=11">Balloon</option>
        <option value="$POGNS,AcftType=12">Airship</option>
        <option value="$POGNS,AcftType=13">UAV/Drone</option>
        <option value="$POGNS,AcftType=14">Ground vehicle</option>
        <option value="$POGNS,AcftType=15">Static object</option>
      </select>
    </div>

    <input id="cmdReg" type="text" placeholder="Call-sign" style="flex:1; min-width:80px;">
    <button id="btnReg" disabled>OK</button>

    <input id="cmdPilot" type="text" placeholder="Pilot-name" style="flex:1; min-width:80px;">
    <button id="btnPilot" disabled>OK</button>

    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <select id="cmdControls" disabled>
        <option value="">Controls</option>
        <option value="$POGNS">Parameters NMEA</option>
        <option value="\\x03">List parameters</option>
        <option value="\\x18\\x18">Restart</option>
        <option value="$POGNS,Verbose=0">Quiet output</option>
        <option value="$POGNS,Verbose=1">Normal output</option>
        <option value="$POGNS,Defaults">Set defaults</option>
      </select>
    </div>

    <input id="customCmd" type="text" value="$POGNS," placeholder="Type command..." style="flex:1; min-width:120px;">
    <button id="btnSendCustom" disabled>OK</button>
  </div>

  <pre id="log" style="margin-top:10px; height:220px; overflow:auto; background:#111; color:#eee; padding:10px; border-radius:6px;"></pre>
</section>

<script>
(() => {
  let port = null;
  let reader = null;
  let keepReading = false;
  const baudRate = 115200; // set to your firmware console baud

  const el = (id) => document.getElementById(id);
  const logEl = el("log");

  function appendLog(s) {
    logEl.textContent += s;
    logEl.scrollTop = logEl.scrollHeight;
  }

  async function connect() {
    if (!("serial" in navigator)) {
      alert("Web Serial not supported. Use Chrome/Edge.");
      return;
    }

    // Ask user to pick the ESP32 serial port
    port = await navigator.serial.requestPort();
    await port.open({ baudRate });

    el("btnConnect").disabled = true;
    el("btnDisconnect").disabled = false;
    el("cmdFreqPlan").disabled = false;
    el("cmdAcftType").disabled = false;
    el("cmdControls").disabled = false;
    el("btnReg").disabled = false;
    el("btnPilot").disabled = false;
    el("btnSendCustom").disabled = false;

    keepReading = true;
    readLoop().catch(e => appendLog(`\n[read error] ${e}\n`));
    appendLog("[connected]\n");
  }

  async function disconnect() {
    keepReading = false;

    try { if (reader) await reader.cancel(); } catch {}
    reader = null;

    try { if (port) await port.close(); } catch {}
    port = null;

    el("btnConnect").disabled = false;
    el("btnDisconnect").disabled = true;
    el("cmdFreqPlan").disabled = true;
    el("cmdAcftType").disabled = true;
    el("cmdControls").disabled = true;
    el("btnReg").disabled = true;
    el("btnPilot").disabled = true;
    el("btnSendCustom").disabled = true;

    appendLog("[disconnected]\n");
  }

  async function readLoop() {
    const decoder = new TextDecoder();
    while (port && port.readable && keepReading) {
      reader = port.readable.getReader();
      try {
        while (keepReading) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) appendLog(decoder.decode(value, { stream: true }));
        }
      } finally {
        reader.releaseLock();
      }
    }
  }

  async function sendLine(line) {
    if (!port || !port.writable) return;
    const encoder = new TextEncoder();
    const writer = port.writable.getWriter();
    try {
      await writer.write(encoder.encode(line + "\r\n"));
    } finally {
      writer.releaseLock();
    }
  }

  el("btnConnect").addEventListener("click", connect);
  el("btnDisconnect").addEventListener("click", disconnect);

  el("cmdFreqPlan").addEventListener("change", async () => {
    const v = el("cmdFreqPlan").value;
    if (!v) return;
    await sendLine(v);
    el("cmdFreqPlan").value = "";   // reset to placeholder
  });

  el("cmdAcftType").addEventListener("change", async () => {
    const v = el("cmdAcftType").value;
    if (!v) return;
    await sendLine(v);
    el("cmdAcftType").value = "";   // reset to placeholder
  });

  el("cmdControls").addEventListener("change", async () => {
    const v = el("cmdControls").value;
    if (!v) return;
    await sendLine(v);
    el("cmdControls").value = "";   // reset to placeholder
  });

  el("btnReg").addEventListener("click", () => {
    const v = el("cmdReg").value.trim();
    if(v) sendLine("$POGNS,Reg="+v);
  });

  el("btnPilot").addEventListener("click", () => {
    const v = el("cmdPilot").value.trim();
    if(v) sendLine("$POGNS,Pilot="+v);
  });

  el("btnSendCustom").addEventListener("click", () => {
    const v = el("customCmd").value.trim();
    if(v) sendLine(v);
  });

})();
</script>

  <script>
    const sel = document.getElementById("variant");
    const btn = document.getElementById("install");
    sel.addEventListener("change", () => {
      btn.setAttribute("manifest", `manifests/manifest-${sel.value}.json`);
    });
  </script>

</body>
</html>

