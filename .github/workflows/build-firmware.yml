name: Build firmware

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install platformio esptool

      - name: Build + merge all variants
        run: |
          mkdir -p docs/firmware docs/manifests

          # env:chip:chipFamily
          VARIANTS=(
            "ttgo-sx1276-tbeam-v10:esp32:ESP32"
            "HTIT-Tracker:esp32s3:ESP32S3"
          )

          for v in "${VARIANTS[@]}"; do
            IFS=: read -r ENV CHIP FAMILY <<< "$v"
            echo "=== Building $ENV ($CHIP) ==="
            pio run -e "$ENV"

            mkdir -p "docs/firmware/$ENV"
            esptool.py --chip "$CHIP" merge_bin \
              -o "docs/firmware/$ENV/merged.bin" \
              0x1000  ".pio/build/$ENV/bootloader.bin" \
              0x8000  ".pio/build/$ENV/partitions.bin" \
              0x10000 ".pio/build/$ENV/firmware.bin"

            cat > "docs/manifests/manifest-$ENV.json" <<EOF
{
  "name": "OGN-Tracker ($ENV)",
  "builds": [{
    "chipFamily": "$FAMILY",
    "parts": [{ "path": "../firmware/$ENV/merged.bin", "offset": 0 }]
  }]
}
EOF
          done

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

